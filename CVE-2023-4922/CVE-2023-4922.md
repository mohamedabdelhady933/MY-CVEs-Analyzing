# CVE-2023-4922 - Unauth LFI in WPB-Show-Core Plugin

![image](https://github.com/mohamedabdelhady933/MY-CVEs-Analyzing/assets/73122852/1c3b6350-8c56-491c-8001-390253364b8e)



## Introduction

ðŸ”Ž **CVE ID:** CVE-2023-4922

ðŸ”§ **Affected Product:** WPB-Show-Core Plugin <= 2.2

ðŸ”’ **Vendor:** WPB Show Core Projects

ðŸž **Vulnerability:** Unauthenticated Local File Inclusion

ðŸ“– **Description:** Local file inclusion that allows attackers to uthorized access to local system files and the application source code.

ðŸ“Ž **Advisory Link:** [CVE-2023-4922](https://nvd.nist.gov/vuln/detail/CVE-2023-4922)


---

## Identifying the code vulnerability (Static Analysis)
I discovered two vulnerabilities, Local File Disclosure (LFD) and Server-Side Request Forgery (SSRF), in the WPB Show Core plugin for WordPress, specifically in the download-file.php file. These vulnerabilities could allow an attacker to read sensitive files on the server or potentially trigger unauthorized requests to internal services.

The WPB-show-core plugin is susceptible to a Local File Inclusion (LFI) vulnerability due to insufficient input validation when processing the ``path`` parameter via the GET request. The vulnerable code can be found within the plugin, where user-supplied data is used directly in a call to the readfile function, potentially allowing an attacker to traverse the file system and include arbitrary files.


The important code of ``download-file.php`` file is shown below at  ``/wp-content/plugins/wpb-show-core/download-file.php`` endpoint 

![image](https://github.com/mohamedabdelhady933/MY-CVEs-Analyzing/assets/73122852/dc3f867e-0855-4e53-a48a-c9173e4e5188)


## Code Review Analysis Approaches

### 1. Line-by-Line Approach

Letâ€™s break down the code step-by-step to understand the vulnerabilities.

1. **Checking for `$_GET['path']`**:
   - The code first checks if the `path` parameter is passed in the query string.
   - There is **no validation** on this parameter, and itâ€™s directly used to retrieve a file on the server.

2. **`urldecode($_GET['path'])`**:
   - The `path` parameter is **URL-decoded** without any sanitation or validation, which is critical because it could be manipulated to point to sensitive or restricted files on the server.
   - This opens the possibility of **Directory Traversal** or accessing internal files that should not be exposed.

3. **Compression Settings for IE**:
   - The code checks if `zlib.output_compression` is enabled, and if so, disables it.
   - This is a minor concern but irrelevant to the vulnerability.

4. **Setting HTTP Headers**:
   - Several headers are set to force the browser to download the file, including `Content-Disposition` and `Content-Type`.
   - This portion is technically fine, but it works on whatever file path is provided, allowing for file disclosure.

5. **Calling `@readfile($path)`**:
   - The `@readfile()` function reads and outputs the fileâ€™s contents directly to the response.
   - This is where the core vulnerability exists. An attacker can pass arbitrary paths and cause the server to send files that shouldn't be accessible to the public.

6. **Exiting the Script**:
   - The script calls `exit()` after serving the file, ensuring no further execution, which is standard for file download scripts but leaves no room for error handling or validation.

### 2. Critical Component First Approach

- **Critical Component: `readfile($path)`**:
  - The most critical and dangerous function here is `@readfile($path)`, which serves the file content directly based on the user-controlled `$_GET['path']` parameter.
  - If thereâ€™s no check or validation on the `$path` value, this becomes a **Local File Disclosure (LFD)** vulnerability, where an attacker can craft paths to sensitive files on the server (e.g., `/etc/passwd`, `/proc/self/environ`, or other critical configuration files).
  
- **LFD Vulnerability**:
  - By manipulating the `path` parameter, an attacker can cause the server to read files outside the intended scope (using **directory traversal** like `../../../../etc/passwd`), thus exposing sensitive data.
  
- **Potential SSRF**:
  - If the path is not a local file but instead a URL (especially on poorly configured servers), it could also lead to **Server-Side Request Forgery (SSRF)** attacks. This occurs when an attacker provides a remote URL that the server fetches, potentially leading to unauthorized access to internal services or systems.

### 3. Source-Sink Approach

- **Source**: The user-controlled `$_GET['path']` is the source of the input.
- **Sink**: The file path is then passed directly to the `@readfile($path)` function, which reads the file or triggers an SSRF request.
- **Mitigation Concern**: There is no validation or sanitization of the `$_GET['path']` input before it is used, which is why both **LFD** and **SSRF** are possible.

















## What is the potential impact? (Attack Scenario)

An attacker can exploit this vulnerability by crafting a malicious ``path`` parameter containing a relative or absolute path to a sensitive file on the server. For example, an attacker could use a payload like ``?path=../../../etc/passwd`` to access the system's password file. If the server has improper file permissions, the attacker may successfully retrieve and download sensitive files.




## Mitigation

* Use filteration for the allowed files.
* Use random IDs for the needed files .
* Disable ``Allow_url_include`` because that cause SSRF too.
* Implementing Access Controls and Restrict Access.
